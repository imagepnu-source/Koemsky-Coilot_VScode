'use client';
import React from 'react';
import type {
  AllCfg, BoxCfg, SmallBoxCfg, FontCfg, LevelBadgeCfg, AgeBadgeCfg
} from '@/lib/ui-design';
import { loadUIDesignCfg, saveUIDesignCfg, applyUIDesignCSS } from '@/lib/ui-design';
import BoxSection from './BoxSection';
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";

function FontSection(props: { label: string; value: FontCfg; onChange: (v: FontCfg) => void }) {
  const { label, value, onChange } = props;
  return (
    <div className="grid grid-cols-3 gap-2 items-center">
      <div className="col-span-1 text-sm">{label}</div>
      <input
        className="border px-2 py-1 w-20"
        type="number"
        value={value.size}
        onChange={(e) => onChange({ ...value, size: Math.max(1, Number(e.target.value) || 1) })}
      />
      <div className="flex items-center gap-2">
        <label className="text-sm">
          <input type="checkbox" checked={value.bold} onChange={(e) => onChange({ ...value, bold: e.target.checked })} /> bold
        </label>
        <input type="color" value={value.color} onChange={(e) => onChange({ ...value, color: e.target.value })} className="w-8 h-8 p-0 border rounded" />
      </div>
    </div>
  );
}

function SmallBoxSection(props: { title?: string; value: SmallBoxCfg; onChange: (v: SmallBoxCfg) => void }) {
  const { title, value, onChange } = props;
  const update = (patch: Partial<SmallBoxCfg>) => onChange({ ...value, ...patch });
  return (
    <div className="space-y-2">
      {title && <div className="font-medium">{title}</div>}
      <div className="grid grid-cols-3 gap-2 items-center">
        <label className="flex items-center gap-2">
          <span className="w-24 text-sm">Background</span>
          <input type="color" value={value.bg} onChange={(e) => update({ bg: e.target.value })} className="w-8 h-8 p-0 border rounded" />
        </label>
        <label className="flex items-center gap-2">
          <span className="w-24 text-sm">Radius</span>
          <input type="number" value={value.radius} onChange={(e) => update({ radius: Math.max(0, Number(e.target.value) || 0) })} className="border px-2 py-1 w-20" />
        </label>
        <label className="flex items-center gap-2">
          <span className="w-24 text-sm">Border</span>
          <input type="number" value={value.borderWidth} onChange={(e) => update({ borderWidth: Math.max(0, Number(e.target.value) || 0) })} className="border px-2 py-1 w-20" />
        </label>
        <label className="col-span-3 flex items-center gap-2">
          <span className="w-24 text-sm">Border color</span>
          <input type="color" value={value.borderColor} onChange={(e) => update({ borderColor: e.target.value })} className="w-8 h-8 p-0 border rounded" />
          <input type="text" value={value.borderColor} onChange={(e) => update({ borderColor: e.target.value })} className="ml-2 border px-2 py-1 text-sm w-full" />
        </label>
      </div>
    </div>
  );
}

export default function UIDesignDialog() {
  const [open, setOpen] = React.useState(false);
  const [cfg, setCfg] = React.useState<AllCfg>(() => {
    try { return loadUIDesignCfg(); } catch { return {} as AllCfg; }
  });

  // Size + position for draggable modal (+50px vertical)
  const [modalSize, setModalSize] = React.useState({ width: 0, height: 0 });
  const [pos, setPos] = React.useState({ x: 0, y: 0 });
  const dragRef = React.useRef({
    dragging: false,
    startX: 0,
    startY: 0,
    startLeft: 0,
    startTop: 0,
  });

  React.useEffect(() => { applyUIDesignCSS(cfg); }, [cfg]);

  React.useEffect(() => {
    const compute = () => {
      const w = Math.round(window.innerWidth * 0.7);
      const h = Math.round(window.innerHeight * 0.7) + 50;
      setModalSize({ width: w, height: h });
      setPos(p => (p.x === 0 && p.y === 0) ? { x: Math.max(8, Math.round((window.innerWidth - w) / 2)), y: Math.max(8, Math.round((window.innerHeight - h) / 2)) } : p);
    };
    compute();
    window.addEventListener('resize', compute);
    return () => window.removeEventListener('resize', compute);
  }, [open]);

  // dragging handlers
  React.useEffect(() => {
    const onMove = (e: MouseEvent) => {
      if (!dragRef.current.dragging) return;
      const dx = e.clientX - dragRef.current.startX;
      const dy = e.clientY - dragRef.current.startY;
      setPos({
        x: Math.max(8, Math.min(window.innerWidth - modalSize.width - 8, dragRef.current.startLeft + dx)),
        y: Math.max(8, Math.min(window.innerHeight - modalSize.height - 8, dragRef.current.startTop + dy)),
      });
    };
    const onUp = () => { dragRef.current.dragging = false; document.body.style.userSelect = ''; };
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
    return () => {
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
    };
  }, [modalSize]);

  const startDrag = (e: React.MouseEvent) => {
    e.preventDefault();
    dragRef.current.dragging = true;
    dragRef.current.startX = e.clientX;
    dragRef.current.startY = e.clientY;
    dragRef.current.startLeft = pos.x;
    dragRef.current.startTop = pos.y;
    document.body.style.userSelect = 'none';
  };

  const update = <K extends keyof AllCfg>(k: K, v: AllCfg[K]) => setCfg(p => ({ ...p, [k]: v }));

  const persist = () => {
    try { saveUIDesignCfg(cfg); applyUIDesignCSS(cfg); } catch {}
  };

  return (
    <>
      <button type="button" className="px-3 py-1 text-sm border rounded" onClick={() => { setOpen(true); applyUIDesignCSS(cfg); }}>
        UI Design 2
      </button>

      {open && (
        <div role="dialog" aria-modal="true" className="fixed inset-0 z-[9999]">
          <div className="absolute inset-0 bg-black/40" onClick={() => setOpen(false)} />
          <div
            className="relative z-10 overflow-hidden rounded-xl bg-white shadow-2xl border"
            style={{
              position: 'fixed',
              left: pos.x,
              top: pos.y,
              width: modalSize.width || '70vw',
              height: modalSize.height || 'calc(70vh + 50px)',
            }}
            aria-label="UI Design Dialog"
          >
            <div className="flex items-center justify-between gap-3 px-4 py-3 border-b cursor-grab" onMouseDown={startDrag}>
              <h2 className="text-lg font-bold">UI Design PopUp 2</h2>
              <div className="flex items-center gap-2">
                <button type="button" className="px-2 py-1 text-sm border rounded" onClick={persist}>Save</button>
                <button type="button" className="px-2 py-1 text-sm border rounded" onClick={() => setOpen(false)}>Close</button>
              </div>
            </div>

            <Tabs defaultValue="list">
              <TabsList>
                <TabsTrigger value="list">Play List</TabsTrigger>
                <TabsTrigger value="detail">Play Detail</TabsTrigger>
                <TabsTrigger value="graph">Graph</TabsTrigger>
              </TabsList>

              <TabsContent value="list">
                <div className="w-full h-[calc(100% - 56px)] overflow-auto px-4 py-3">
                  <div className="space-y-4">

                    {/* 상단 컨테이너 */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">상단 컨테이너 (미리보기)</div>
                      <BoxSection title="상단 컨테이너 속성" value={cfg.topHeaderBox} onChange={(v: BoxCfg) => update('topHeaderBox', v)} />
                    </div>

                    {/* 카테고리(발달나이) */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">카테고리 (발달 나이 표시)</div>
                      <div className="grid gap-2">
                        <div className="text-sm mb-1">Category label</div>
                        <div className="grid grid-cols-2 gap-2 items-center">
                          <div>
                            <label className="text-sm">Size</label>
                            <input type="number" className="border px-2 py-1 w-24" value={cfg.catag.size} onChange={(e) => update('catag', { ...cfg.catag, size: Math.max(8, Number(e.target.value) || 8) })} />
                          </div>
                          <div className="flex items-center gap-2">
                            <label className="text-sm"><input type="checkbox" checked={cfg.catag.bold} onChange={(e) => update('catag', { ...cfg.catag, bold: e.target.checked })} /> bold</label>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* 플레이 리스트 컨테이너 */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">놀이 리스트 컨테이너</div>
                      <BoxSection title="Play List Box" value={cfg.playListBox} onChange={(v: BoxCfg) => update('playListBox', v)} />
                    </div>

                    {/* Activity row / card container */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">Activity Row · 카드 (상위 컨테이너)</div>
                      <SmallBoxSection title="Activity Box" value={cfg.activityBox} onChange={(v: SmallBoxCfg) => update('activityBox', v)} />
                    </div>

                    {/* Badge · Level (칩 컨테이너) */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">Badge · Level (칩 컨테이너)</div>
                      <SmallBoxSection title="Level Badge Box" value={cfg.levelBadgeBox} onChange={(v: SmallBoxCfg) => update('levelBadgeBox', v)} />
                      <div className="mt-2">
                        <div className="text-sm mb-1">Level Badge (chip)</div>
                        <div className="grid grid-cols-3 gap-2 items-center">
                          <label className="flex items-center gap-2"><span className="w-24 text-sm">BG</span><input type="color" value={cfg.levelBadge.bg} onChange={(e) => update('levelBadge', { ...cfg.levelBadge, bg: e.target.value })} className="w-8 h-8 p-0 border rounded" /></label>
                          <label className="flex items-center gap-2"><span className="w-24 text-sm">Radius</span><input type="number" className="border px-2 py-1 w-20" value={cfg.levelBadge.radius} onChange={(e) => update('levelBadge', { ...cfg.levelBadge, radius: Math.max(0, Number(e.target.value) || 0) })} /></label>
                          <label className="flex items-center gap-2"><span className="w-24 text-sm">Height</span><input type="number" className="border px-2 py-1 w-20" value={cfg.levelBadge.height} onChange={(e) => update('levelBadge', { ...cfg.levelBadge, height: Math.max(0, Number(e.target.value) || 0) })} /></label>
                        </div>
                      </div>
                    </div>

                    {/* Activity (번호 + 제목) 텍스트 */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">Activity (번호+제목) 텍스트</div>
                      <FontSection label="Activity text" value={cfg.activity} onChange={(v: FontCfg) => update('activity', v)} />
                    </div>

                    {/* Age badge */}
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">Age Badge</div>
                      <div className="grid gap-2">
                        <div className="grid grid-cols-3 gap-2 items-center">
                          <label className="flex items-center gap-2"><span className="w-24 text-sm">BG</span><input type="color" value={cfg.ageBadge.bg} onChange={(e) => update('ageBadge', { ...cfg.ageBadge, bg: e.target.value })} className="w-8 h-8 p-0 border rounded" /></label>
                          <label className="flex items-center gap-2"><span className="w-24 text-sm">Color</span><input type="color" value={cfg.ageBadge.color} onChange={(e) => update('ageBadge', { ...cfg.ageBadge, color: e.target.value })} className="w-8 h-8 p-0 border rounded" /></label>
                          <label className="flex items-center gap-2"><span className="w-24 text-sm">Font size</span><input type="number" className="border px-2 py-1 w-20" value={cfg.ageBadge.fontSize} onChange={(e) => update('ageBadge', { ...cfg.ageBadge, fontSize: Math.max(8, Number(e.target.value) || 8) })} /></label>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </TabsContent>

              <TabsContent value="detail">
                <div className="p-4">
                  <div className="space-y-4">
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">Detail Title / Body</div>
                      <FontSection label="Detail title" value={cfg.detailTitle} onChange={(v: FontCfg) => update('detailTitle', v)} />
                      <div className="mt-2" />
                      <FontSection label="Detail body" value={cfg.detailBody} onChange={(v: FontCfg) => update('detailBody', v)} />
                    </div>
                    <div className="p-3 rounded-lg border">
                      <div className="font-semibold mb-2">Difficulty box</div>
                      <SmallBoxSection title="Difficulty Box" value={cfg.difficultyBox} onChange={(v: SmallBoxCfg) => update('difficultyBox', v)} />
                      <div className="mt-2">
                        <FontSection label="Difficulty text" value={cfg.difficultyText} onChange={(v: FontCfg) => update('difficultyText', v)} />
                      </div>
                    </div>
                  </div>
                </div>
              </TabsContent>

              <TabsContent value="graph">
                <div className="p-4 text-sm text-muted-foreground">Graph-related UI settings will appear here.</div>
              </TabsContent>
            </Tabs>
          </div>
        </div>
      )}
    </>
  );
}